#!/usr/bin/env bash

# blogwriter CLI Tool
# Generated by Docker Project Builder

set -e

# Get script directory
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
PROJECT_ROOT="${SCRIPT_DIR}"

# Source common utilities
source "${SCRIPT_DIR}/bin/cli/common.sh"

# ── Parse --env flag from any position ───────────────────────────
REMAINING_ARGS=()
for arg in "$@"; do
    case "$arg" in
        --env=*)
            export APP_ENV="${arg#*=}"
            ;;
        *)
            REMAINING_ARGS+=("$arg")
            ;;
    esac
done
set -- "${REMAINING_ARGS[@]}"

show_help() {
    cat << EOF
blogwriter CLI - Docker Project Management Tool

Usage: ./cli [--env=<env>] [command] [options]

Commands:
    up          Start all containers
    down        Stop and remove containers
    clean       Remove containers, volumes, and local images
    build       Build or rebuild containers
    install     Install npm dependencies (all or specific service)
    logs        View container logs
    exec        Execute a command in a container
    shell       Open a shell in a container
    status      Show container status
    restart     Restart containers
    db          Database commands (migrate, generate, push)
    user        User management (set_role, set_password)
    typecheck   Run TypeScript type checking (all or specific service)
    certs       Generate SSL certificates (self-signed or Let's Encrypt)
    certs-renew Renew Let's Encrypt certificates
    env         Interactive environment configuration
    version     Show or bump the project version
    domain      Show or change the project domain
    deploy      Guided deployment wizard
    help        Show this help message

Options:
    --env=<env> Override APP_ENV (local, staging, prod). Default: from .env or "local"

Examples:
    ./cli up
    ./cli --env=prod up
    ./cli up --env=staging
    ./cli install           # install deps in api + nextjs
    ./cli install nextjs    # install deps in nextjs only
    ./cli logs api
    ./cli shell nextjs
    ./cli exec api npm install
    ./cli db migrate
    ./cli certs
    ./cli env               # interactive .env setup
    ./cli deploy            # guided deployment wizard

EOF
}

# Command dispatcher
COMMAND="${1:-help}"
shift || true

case "${COMMAND}" in
    up)
        source "${SCRIPT_DIR}/bin/cli/commands/up.sh"
        ;;
    down)
        source "${SCRIPT_DIR}/bin/cli/commands/down.sh"
        ;;
    clean)
        source "${SCRIPT_DIR}/bin/cli/commands/clean.sh"
        ;;
    build)
        source "${SCRIPT_DIR}/bin/cli/commands/build.sh"
        ;;
    install)
        source "${SCRIPT_DIR}/bin/cli/commands/install.sh"
        ;;
    logs)
        source "${SCRIPT_DIR}/bin/cli/commands/logs.sh"
        ;;
    exec)
        source "${SCRIPT_DIR}/bin/cli/commands/exec.sh"
        ;;
    shell)
        source "${SCRIPT_DIR}/bin/cli/commands/shell.sh"
        ;;
    status)
        source "${SCRIPT_DIR}/bin/cli/commands/status.sh"
        ;;
    restart)
        source "${SCRIPT_DIR}/bin/cli/commands/restart.sh"
        ;;
    db)
        source "${SCRIPT_DIR}/bin/cli/commands/db.sh"
        ;;
    user)
        source "${SCRIPT_DIR}/bin/cli/commands/user.sh"
        ;;
    typecheck)
        source "${SCRIPT_DIR}/bin/cli/commands/typecheck.sh"
        ;;
    certs)
        source "${SCRIPT_DIR}/bin/cli/commands/certs.sh"
        ;;
    certs-renew)
        source "${SCRIPT_DIR}/bin/cli/commands/certs-renew.sh"
        ;;
    env)
        source "${SCRIPT_DIR}/bin/cli/commands/env.sh"
        ;;
    version)
        source "${SCRIPT_DIR}/bin/cli/commands/version.sh"
        ;;
    domain)
        load_env
        source "${SCRIPT_DIR}/bin/cli/commands/domain.sh"
        ;;
    deploy)
        source "${SCRIPT_DIR}/bin/cli/commands/deploy.sh"
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        error "Unknown command: ${COMMAND}"
        echo ""
        show_help
        exit 1
        ;;
esac
