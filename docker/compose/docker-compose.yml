name: blogwriter
services:
  proxy:
    build:
      context: ../..
      dockerfile: docker/proxy/Dockerfile
    container_name: ${CONTAINER_PREFIX:-blogwriter}-proxy
    ports:
      - ${PROXY_PORT:-8081}:80
      - ${PROXY_SSL_PORT:-8444}:443
    environment:
      DOMAIN: ${DOMAIN:-}
    networks:
      - app-network
    depends_on:
      - api
      - nextjs
    restart: unless-stopped
    healthcheck:
      test:
        - CMD
        - wget
        - --quiet
        - --tries=1
        - --spider
        - http://localhost:80/
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
  api:
    build:
      context: ../..
      dockerfile: docker/images/api.Dockerfile
    container_name: ${CONTAINER_PREFIX:-blogwriter}-api
    environment:
      PORT: "4000"
      DATABASE_URL: postgresql://${POSTGRES_USER:-blogwriter_user}:${POSTGRES_PASSWORD:-blogwriter_pass}@postgres:5432/${POSTGRES_DB:-blogwriter_db}
      ADMIN_TOKEN: ${ADMIN_TOKEN:-dev-admin-token}
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY:-}
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test:
        - CMD
        - wget
        - --quiet
        - --tries=1
        - --spider
        - http://localhost:4000/health
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
  nextjs:
    build:
      context: ../..
      dockerfile: docker/images/nextjs.Dockerfile
    container_name: ${CONTAINER_PREFIX:-blogwriter}-nextjs
    environment:
      NEXT_TELEMETRY_DISABLED: "1"
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://blogwriter.test:4444}
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test:
        - CMD
        - wget
        - --quiet
        - --tries=1
        - --spider
        - http://localhost:3000/
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
  postgres:
    image: postgres:16-alpine
    container_name: ${CONTAINER_PREFIX:-blogwriter}-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-blogwriter_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-blogwriter_pass}
      POSTGRES_DB: ${POSTGRES_DB:-blogwriter_db}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test:
        - CMD-SHELL
        - pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
  valkey:
    image: valkey/valkey:latest
    container_name: ${CONTAINER_PREFIX:-blogwriter}-valkey
    command: valkey-server --appendonly yes
    volumes:
      - valkey_data:/data
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test:
        - CMD
        - valkey-cli
        - ping
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
volumes:
  postgres_data:
    driver: local
  valkey_data:
    driver: local
networks:
  app-network:
    driver: bridge
