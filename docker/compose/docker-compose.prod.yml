services:
  proxy:
    environment:
      - DOMAIN=${DOMAIN:?DOMAIN must be set in .env}
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ssl-certs:/usr/local/apache2/conf/ssl:ro
      - acme-challenge:/usr/local/apache2/htdocs

  api:
    build:
      target: production
    environment:
      NODE_ENV: production
      CORS_ORIGIN: ${CORS_ORIGIN:-https://${DOMAIN}}

  nextjs:
    build:
      target: production
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-https://${DOMAIN}}
    environment:
      NODE_ENV: production
      HOSTNAME: "0.0.0.0"

  postgres:
    profiles:
      - db

  valkey:
    profiles:
      - db

  api-migrations:
    build:
      context: ../..
      dockerfile: docker/images/api.Dockerfile
      target: migrations
    container_name: ${CONTAINER_PREFIX:-blogwriter}-api-migrations
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-blogwriter_user}:${POSTGRES_PASSWORD:-blogwriter_pass}@postgres:5432/${POSTGRES_DB:-blogwriter_db}
    profiles:
      - tools
    networks:
      - app-network

  certbot:
    image: certbot/certbot:latest
    container_name: ${CONTAINER_PREFIX:-blogwriter}-certbot
    volumes:
      - letsencrypt-data:/etc/letsencrypt
      - ssl-certs:/etc/ssl-output
      - acme-challenge:/var/www/certbot
    profiles:
      - certbot
    networks:
      - app-network

  certbot-renew:
    image: certbot/certbot:latest
    container_name: ${CONTAINER_PREFIX:-blogwriter}-certbot-renew
    entrypoint: sh
    command:
      - -c
      - |
        echo "Certbot auto-renewal service started (checks every 12h)"
        trap exit TERM INT
        while true; do
          sleep 43200 &
          wait $$!
          echo "[`date`] Running certbot renew..."
          certbot renew --webroot -w /var/www/certbot \
            --deploy-hook "cp -L /etc/letsencrypt/live/$$DOMAIN/fullchain.pem /etc/ssl-output/$$DOMAIN.crt && cp -L /etc/letsencrypt/live/$$DOMAIN/privkey.pem /etc/ssl-output/$$DOMAIN.key && cp -L /etc/letsencrypt/live/$$DOMAIN/chain.pem /etc/ssl-output/ca.crt && echo Certificates renewed and copied"
        done
    environment:
      DOMAIN: ${DOMAIN:?DOMAIN must be set}
    volumes:
      - letsencrypt-data:/etc/letsencrypt
      - ssl-certs:/etc/ssl-output
      - acme-challenge:/var/www/certbot
    profiles:
      - auto-renew
    networks:
      - app-network
    restart: unless-stopped

volumes:
  ssl-certs:
    driver: local
  letsencrypt-data:
    driver: local
  acme-challenge:
    driver: local
