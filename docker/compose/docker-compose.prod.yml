services:
  proxy:
    environment:
      - DOMAIN=${DOMAIN:?DOMAIN must be set in .env}
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ssl-certs:/usr/local/apache2/conf/ssl:ro
      - acme-challenge:/usr/local/apache2/htdocs/.well-known/acme-challenge

  api:
    build:
      target: production
    environment:
      NODE_ENV: production
      CORS_ORIGIN: ${CORS_ORIGIN:-https://${DOMAIN}}

  nextjs:
    build:
      target: production
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-https://${DOMAIN}}
    environment:
      NODE_ENV: production
      HOSTNAME: "0.0.0.0"

  postgres:
    profiles:
      - db

  valkey:
    profiles:
      - db

  certbot:
    image: certbot/certbot:latest
    container_name: ${CONTAINER_PREFIX:-blogwriter}-certbot
    volumes:
      - letsencrypt-data:/etc/letsencrypt
      - ssl-certs:/etc/ssl-output
      - acme-challenge:/var/www/certbot
    profiles:
      - certbot
    networks:
      - app-network

volumes:
  ssl-certs:
    driver: local
  letsencrypt-data:
    driver: local
  acme-challenge:
    driver: local
