<VirtualHost *:80>
    ServerName api.blogwriter.test
    ServerAdmin admin@blogwriter.test

    # Error and access logs (Docker-friendly: stdout/stderr)
    ErrorLog /proc/self/fd/2
    CustomLog /proc/self/fd/1 combined

    # ACME challenge directory (for Let's Encrypt HTTP-01 validation)
    Alias /.well-known/acme-challenge/ /usr/local/apache2/htdocs/.well-known/acme-challenge/
    <Directory "/usr/local/apache2/htdocs/.well-known/acme-challenge/">
        Options None
        AllowOverride None
        Require all granted
    </Directory>

    # Redirect to HTTPS when certificates are present
    <IfFile "/usr/local/apache2/conf/ssl/blogwriter.test.crt">
        RewriteEngine On
        RewriteCond %{REQUEST_URI} !^/\.well-known/acme-challenge/
        RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]
    </IfFile>

    # Proxy to api
    ProxyPass / http://api:4000/
    ProxyPassReverse / http://api:4000/
</VirtualHost>

<IfFile "/usr/local/apache2/conf/ssl/blogwriter.test.crt">
<VirtualHost *:443>
    ServerName api.blogwriter.test
    ServerAdmin admin@blogwriter.test

    SSLEngine on
    SSLCertificateFile /usr/local/apache2/conf/ssl/blogwriter.test.crt
    SSLCertificateKeyFile /usr/local/apache2/conf/ssl/blogwriter.test.key
    SSLCACertificateFile /usr/local/apache2/conf/ssl/ca.crt

    # Error and access logs (Docker-friendly: stdout/stderr)
    ErrorLog /proc/self/fd/2
    CustomLog /proc/self/fd/1 combined

    # Proxy to api
    ProxyPass / http://api:4000/
    ProxyPassReverse / http://api:4000/
</VirtualHost>
</IfFile>

<VirtualHost *:80>
    ServerName www.blogwriter.test
    ServerAdmin admin@blogwriter.test

    # Error and access logs (Docker-friendly: stdout/stderr)
    ErrorLog /proc/self/fd/2
    CustomLog /proc/self/fd/1 combined

    # ACME challenge directory (for Let's Encrypt HTTP-01 validation)
    Alias /.well-known/acme-challenge/ /usr/local/apache2/htdocs/.well-known/acme-challenge/
    <Directory "/usr/local/apache2/htdocs/.well-known/acme-challenge/">
        Options None
        AllowOverride None
        Require all granted
    </Directory>

    # Redirect to HTTPS when certificates are present
    <IfFile "/usr/local/apache2/conf/ssl/blogwriter.test.crt">
        RewriteEngine On
        RewriteCond %{REQUEST_URI} !^/\.well-known/acme-challenge/
        RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]
    </IfFile>

    # Proxy to nextjs
    ProxyPass / http://nextjs:3000/
    ProxyPassReverse / http://nextjs:3000/
</VirtualHost>

<IfFile "/usr/local/apache2/conf/ssl/blogwriter.test.crt">
<VirtualHost *:443>
    ServerName www.blogwriter.test
    ServerAdmin admin@blogwriter.test

    SSLEngine on
    SSLCertificateFile /usr/local/apache2/conf/ssl/blogwriter.test.crt
    SSLCertificateKeyFile /usr/local/apache2/conf/ssl/blogwriter.test.key
    SSLCACertificateFile /usr/local/apache2/conf/ssl/ca.crt

    # Error and access logs (Docker-friendly: stdout/stderr)
    ErrorLog /proc/self/fd/2
    CustomLog /proc/self/fd/1 combined

    # Proxy to nextjs
    ProxyPass / http://nextjs:3000/
    ProxyPassReverse / http://nextjs:3000/
</VirtualHost>
</IfFile>
