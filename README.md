# blogwriter

Docker-based project with multi-service architecture.

## ğŸš€ Quick Start

```bash
# Start all services
./cli up

# View logs
./cli logs

# Stop all services
./cli down
```

## ğŸ“‹ Services

- **api** (app) - vlatest
- **nextjs** (app) - vlatest
- **postgres** (database) - vlatest
- **valkey** (cache) - vlatest
- **proxy** (proxy) - vlatest

## ğŸ› ï¸ CLI Commands

```bash
# Start containers
./cli up

# Stop containers
./cli down

# Build/rebuild containers
./cli build [service]

# View logs
./cli logs [service] [-f]

# Execute command in container
./cli exec <service> <command>

# Open shell in container
./cli shell <service>

# Show container status
./cli status

# Restart containers
./cli restart [service]
```

## ğŸ—„ï¸ Database Migrations

This project uses [Drizzle ORM](https://orm.drizzle.team/) for database management. Migration files live in `apps/api/drizzle/`.

```bash
# Run pending migrations
./cli db migrate

# Generate migration files after changing the schema (apps/api/src/db/schema.ts)
./cli db generate

# Push schema changes directly without migration files (useful for dev)
./cli db push
```

**Workflow for schema changes:**
1. Edit the schema in `apps/api/src/db/schema.ts`
2. Generate a migration: `./cli db generate`
3. Review the generated SQL in `apps/api/drizzle/`
4. Apply it: `./cli db migrate`

## Versioning & Cache Busting

The app version lives in the `VERSION` file at the project root and is used to bust browser caches on deploy.

### How it works

1. **`VERSION` file** â€” Single source of truth (e.g. `0.0.1`). Mounted into containers at `/etc/app-version`.
2. **Next.js `generateBuildId`** â€” Uses the version as the build ID, so all `/_next/static/` chunk URLs change when the version bumps. This forces browsers to fetch fresh assets.
3. **Apache proxy headers** â€” HTML and API responses are served with `no-cache, no-store, must-revalidate`. Fingerprinted Next.js assets (`/_next/static/`) are served with `immutable` + 1-year max-age since their URLs already include the version hash.
4. **Admin UI** â€” The current version is displayed as a badge in the Settings page.

### Bumping the version

```bash
# Show current version
./cli version

# Bump patch (0.0.1 -> 0.0.2)
./cli version patch

# Bump minor (0.0.2 -> 0.1.0)
./cli version minor

# Bump major (0.1.0 -> 1.0.0)
./cli version major

# Set a specific version
./cli version set 2.0.0
```

After bumping, restart the Next.js container so it picks up the new build ID:

```bash
./cli restart nextjs
```

On the next deploy / container rebuild, users will automatically receive fresh assets.

## ğŸ“ Project Structure

```
blogwriter/
â”œâ”€â”€ apps/                  # Application source code
â”œâ”€â”€ docker/               # Docker configuration
â”‚   â”œâ”€â”€ compose/         # Docker compose files
â”‚   â”œâ”€â”€ images/          # Custom Dockerfiles
â”‚   â”œâ”€â”€ scripts/         # Entrypoint scripts
â”‚   â””â”€â”€ proxy/           # Proxy configuration
â”œâ”€â”€ bin/cli/             # CLI tool internals
â”œâ”€â”€ .env                 # Environment variables
â””â”€â”€ cli                    # Main CLI tool
```

## ğŸŒ Access URLs

- Main: http://blogwriter.test:8081
- api: http://blogwriter.test:8081/api
- nextjs: http://blogwriter.test:8081/nextjs

## ğŸ”§ Configuration

Edit `.env` file to configure:
- Database credentials
- Service ports
- Domain settings
- Other environment-specific values

## ğŸ“ Generated by Docker Project Builder

This project was generated using [Docker Project Builder](https://github.com/yourusername/docker-project-builder).
